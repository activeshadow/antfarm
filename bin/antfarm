#!/usr/bin/env ruby

require 'antfarm'
require 'trollop'

COMMANDS  = ['help', 'list']
COMMANDS << Antfarm.plugins.keys
COMMANDS.flatten

parser = Trollop::Parser.new do
  version "ANTFARM #{Antfarm.version} - (c) #{Time.now.strftime('%Y')} Sandia National Laboratories"
  banner <<-EOF
ANTFARM is a passive network mapping tool capable of parsing data files generated by common network
administration tools, network equipment configuration files, etc. Designed for use when assessing
critical infrastructure control systems.

Usage:
  antfarm <globals> help <plugin>       # Display the application or plugin help message
  antfarm <globals> list                # List the available plugins
  antfarm <globals> <plugin> <options>  # Execute given plugin with given options

Where <globals> are:
  EOF

  opt :environment,
      "Environment to use for this instance of ANTFARM (defaults to 'antfarm')",
      :type => String
  opt :log_level,
      "Level to log ANTFARM messages (defaults to 'warn')",
      :type => String
  opt :prefix,
      "Default subnet prefix to use if an IP address doesn't specify it (defaults to 30)",
      :type => Integer

  stop_on COMMANDS
end

options = Trollop::with_standard_exception_handling(parser) do
  parser.parse
end

command = ARGV.shift
command = 'help' if command.nil? or command.empty?

# Setting global parameters and processing application...

Antfarm::Initializer.run do |config|
  config.environment = options[:environment] if options[:environment]
  config.log_level   = options[:log_level]   if options[:log_level]
  config.prefix      = options[:prefix]      if options[:prefix]
  config.outputter   = lambda { |msg| STDOUT.puts msg.join }
end

# Executing command...

case command
when 'help'
  if ARGV.empty?
    parser.educate
  else
    plugin_name = ARGV.shift
    if plugin = Antfarm.plugins[plugin_name]

      # TODO: write parser creator and options helper methods
      parser = Trollop::Parser.new do
        banner "#{plugin.name} - #{plugin.info[:desc]}\n\nOptions:"
        plugin.options.each do |option|
          opt option[:name].to_sym, option[:desc], :type => option[:type], :required => option[:required]
        end
      end

      parser.educate
    else
      Antfarm.output "Unknown plugin '#{plugin_name}' given. Below is a list of known plugins.\n\n"

      # TODO: write helper method for listing plugins
      Antfarm.plugins.each do |k,v|
        Antfarm.output "#{k} - #{v.info[:desc]}"
      end
    end
  end
when 'list'
  if Antfarm.plugins.empty?
    Antfarm.output 'No plugins currently loaded.'
  else
    require 'terminal-table'

    rows = Array.new
    Antfarm.plugins.each do |k,v|
      rows << [k, v.info[:desc]]
    end

    table = Terminal::Table.new :title    => 'Available ANTFARM Plugins',
                                :headings => ['Plugin', 'Description'],
                                :rows     => rows

    Antfarm.output "\n#{table.to_s}\n\n"
  end
else
  if plugin = Antfarm.plugins[command]

    # TODO: only require if a default isn't set...
    options = Trollop::options do
      banner "#{plugin.name} - #{plugin.info[:desc]}\n\nOptions:"
      plugin.options.each do |option|
        opt option[:name].to_sym, option[:desc], :type => option[:type], :required => option[:required], :default => option[:default]
      end
    end

    plugin.run(options)
  else
    Antfarm.output "Invalid command '#{command}' given. See help message below for valid commands.\n\n"
    parser.educate
  end
end
